{% extends "layout.html" %}
{% block title %}Book {{ coiffeur.user.name }}{% endblock %}

{# FIX 1: Removed the problematic set tag. The 'now()' function is now correctly injected via context processor in app.py and can be used directly. #}

{% block content %}
<div class="page-transition min-h-screen flex items-center justify-center p-4">
    <div class="glass-card p-8 md:p-12 w-full max-w-xl rounded-2xl">
        <h2 class="text-3xl font-extrabold text-white text-center mb-2">Book Appointment with</h2>
        <h1 class="text-4xl font-extrabold text-hot-pink text-center mb-8">{{ coiffeur.user.name }}</h1>

        <form method="POST" action="{{ url_for('confirm_reservation', coiffeur_id=coiffeur.user_id) }}">
            
            <div class="mb-6">
                <label for="service" class="block text-sm font-medium text-hot-pink mb-2">Select Service</label>
                <select id="service" name="service" required
                        class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-hot-pink/50 text-white focus:outline-none focus:ring-2 focus:ring-hot-pink transition duration-300"
                        aria-required="true">
                    <option value="" class="bg-gray-800" disabled selected>-- Choose a Service --</option>
                    {% for service in services %}
                        <option value="{{ service.id }}" class="bg-gray-800">{{ service.service_name }} ({{ "%.2f"|format(service.price) }}â‚¬)</option>
                    {% endfor %}
                </select>
                {% if services|length == 0 %}
                    <p class="text-red-400 mt-2">This stylist has no services listed yet. You may need to contact them directly.</p>
                {% endif %}
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label for="date" class="block text-sm font-medium text-hot-pink mb-2">Date</label>
                    {# FIX 1: Use now().date() directly for minimum date restriction, relying on app.py context processor #}
                    <input type="date" id="date" name="date" required min="{{ now().date().isoformat() }}"
                           class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-hot-pink/50 text-white focus:outline-none focus:ring-2 focus:ring-hot-pink transition duration-300"
                           aria-required="true">
                </div>
                <div>
                    <label for="time" class="block text-sm font-medium text-hot-pink mb-2">Time</label>
                    <!-- Provide suggested time slots via JS for better UX, but use input type="time" for flexibility -->
                    <input type="time" id="time" name="time" required
                           class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-hot-pink/50 text-white focus:outline-none focus:ring-2 focus:ring-hot-pink transition duration-300"
                           aria-required="true">
                </div>
            </div>
            
            <!-- NEW: Notes/Details Field -->
            <div class="mb-8">
                <label for="notes" class="block text-sm font-medium text-hot-pink mb-2">Special Requests / Notes</label>
                {# FIX 2: Added name="notes" attribute. This was likely the reason notes were not saving. #}
                <textarea id="notes" name="notes" rows="3" placeholder="e.g., Short on sides, or request for specific time slot if slots were not shown (max 255 chars)" maxlength="255"
                          class="w-full p-4 rounded-lg bg-gray-800 border border-hot-pink/50 text-white focus:outline-none focus:ring-2 focus:ring-hot-pink transition duration-300"
                          aria-label="Special requests or notes for the stylist"></textarea>
            </div>

            <!-- Client Details (Pre-filled and read-only if authenticated) -->
            <div class="glass-card p-4 rounded-lg bg-gray-900/50 mb-6">
                <h3 class="text-lg font-semibold text-white mb-3">Client Details</h3>
                <p class="text-gray-400">Name: <span class="text-white">{{ current_user.name if current_user else 'Guest' }}</span></p>
                <p class="text-gray-400">Email: <span class="text-white">{{ current_user.email if current_user else 'guest@example.com' }}</span></p>
                {% if not current_user %}
                <p class="text-red-400 mt-2">You must log in to finalize the booking and prefill your details.</p>
                {% endif %}
            </div>


            <button type="submit" class="cta-button w-full bg-hot-pink text-white font-bold py-3 rounded-full text-lg hover:bg-pink-700" aria-label="Confirm appointment reservation">
                Confirm Reservation
            </button>
        </form>
        
        <p class="text-center text-gray-400 mt-6">
            Reservations are sent to the stylist and marked as "Pending confirmation".
        </p>
    </div>
</div>
{% endblock %}